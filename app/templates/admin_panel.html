<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<link rel="stylesheet" href="/static/admin.css">
</head>

<body class="theme-cyber">
<main class="app">

<header class="topbar">
    <div class="topbar-left">
        <h1>Admin Panel</h1>
    </div>
    <div class="topbar-right">
        <button class="secondary small" onclick="location.href='/recipes-ui'">
            Back
        </button>
    </div>
</header>

<section class="admin-section">

<h2>Login logs</h2>

<div class="tabs">
    <button class="primary" onclick="showTab('login')">Login Logs</button>
    <button class="primary" onclick="showTab('request')">Request Logs</button>
</div>

<div id="request-controls" style="display:none;">
    <div class="filters">
        <button class="secondary small" onclick="filterRequests('all')">All</button>
        <button class="secondary small" onclick="filterRequests('suspicious')">Suspicious</button>
        <button class="secondary small" onclick="filterRequests('error')">Errors</button>
        <button class="secondary small" onclick="filterRequests('blocked')">Blocked</button>
    </div>

    <div class="legend">
        <span class="legend-fail">‚ùå Login fail</span>
        <span class="legend-suspicious">‚ö† Suspicious</span>
        <span class="legend-error">üî• Server error</span>
    </div>
</div>
<div id="login-tab" class="tab-content">
    <table id="login-logs-table" class="admin-table">
        <tr>
            <th>User</th>
            <th>IP</th>
            <th>Status</th>
            <th>Date</th>
            <th>Agent</th>
        </tr>
    </table>
</div>

<div id="request-tab" class="tab-content" style="display:none;">
    <table id="request-logs-table" class="admin-table">
        <tr>
            <th>Path</th>
            <th>IP</th>
            <th>Status</th>
            <th>Date</th>
            <th>Agent</th>
        </tr>
    </table>
</div>

</section>

<script>
    let requestLogsCache = [];
function showTab(tab) {
    document.getElementById("login-tab").style.display =
        tab === 'login' ? 'block' : 'none';

    document.getElementById("request-tab").style.display =
        tab === 'request' ? 'block' : 'none';

    document.getElementById("request-controls").style.display =
        tab === 'request' ? 'block' : 'none';
}

async function loadLoginLogs() {
    const res = await fetch("/api/v1/admin/login-logs");
    const logs = await res.json();
    const table = document.getElementById("login-logs-table");
    table.querySelectorAll("tr:not(:first-child)").forEach(tr => tr.remove());

    logs.forEach(log => {
        const tr = document.createElement("tr");
        tr.className = log.success ? "ok" : "fail";
        tr.innerHTML = `
            <td>${log.username}</td>
            <td>${log.ip_address}</td>
            <td>${log.success ? "OK" : "FAIL"}</td>
            <td>${new Date(log.created_at).toLocaleString()}</td>
            <td>${log.user_agent.slice(0,40)}...</td>
        `;
        table.appendChild(tr);
    });
}
async function loadRequestLogs() {
    const res = await fetch("/api/v1/admin/requests");
    const logs = await res.json();

    requestLogsCache = logs;
    renderRequestLogs(logs);
}
function renderRequestLogs(logs) {
    const table = document.getElementById("request-logs-table");
    table.querySelectorAll("tr:not(:first-child)").forEach(tr => tr.remove());

    logs.forEach(log => {
        const tr = document.createElement("tr");

        if (log.is_suspicious) tr.classList.add("suspicious");
        if (log.status_code >= 500) tr.classList.add("error");
        if (log.status_code === 403) tr.classList.add("blocked");

        tr.innerHTML = `
            <td>${log.path}</td>
            <td>${log.ip_address}</td>
            <td>${log.status ?? "-"}</td>
            <td>${new Date(log.created_at).toLocaleString()}</td>
            <td>${log.user_agent?.slice(0,40) || ""}</td>
        `;
        table.appendChild(tr);
    });
}
function filterRequests(type) {
    if (type === "all") {
        renderRequestLogs(requestLogsCache);
        return;
    }

    let filtered = [];

    if (type === "suspicious") {
        filtered = requestLogsCache.filter(l => l.is_suspicious);
    }

    if (type === "error") {
        filtered = requestLogsCache.filter(l => l.status_code >= 500);
    }

    if (type === "blocked") {
        filtered = requestLogsCache.filter(l => l.status_code === 403);
    }

    renderRequestLogs(filtered);



}

// Na start
loadLoginLogs();
loadRequestLogs();

showTab('login');
</script>

</main>


</body>
</html>
